<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title">Add Product</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="max-height: 380px; overflow-y: auto; padding: 10px 18px">
        <form [formGroup]="addProductForm" (ngSubmit)="submitAddProduct()">
          <!-- Product Name -->
          <div class="my-2">
            <label class="form-label">Product Name</label>
            <input formControlName="productName" type="text" class="form-control" />
          </div>
          <!-- Description -->
          <div class="my-2">
            <label class="form-label">Description</label>
            <input formControlName="productDesc" type="text" class="form-control" />
          </div>
          <!-- Price + Discount -->
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Price</label>
              <input formControlName="price" type="number" class="form-control" />
            </div>
            <div class="col-6">
              <label class="form-label">Discount</label>
              <input formControlName="discountPrice" type="number" class="form-control" />
            </div>
          </div>
          <!-- Category + Stock -->
          <div class="row g-2 my-2">
            <div class="col-6">
              <label class="form-label">Category</label>
              <select
                class="form-select"
                formControlName="category"
                (change)="onCategoryChange($event)"
              >
                <option value="">Select Category</option>
                <ng-container *ngFor="let cat of uniqueCategories">
                  <option [value]="cat">{{ cat }}</option>
                </ng-container>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Stock</label>
              <input formControlName="stock" type="number" class="form-control" />
            </div>
          </div>
          <!-- Sub Category -->
          <div class="my-2">
            <label class="form-label">Sub Category</label>
            <select class="form-select" formControlName="subCategory">
              <option value="">Select Sub Category</option>
              <ng-container *ngFor="let sub of filteredSubCategories">
                <option [value]="sub.name">{{ sub.name }}</option>
              </ng-container>
            </select>
          </div>
          <!-- Upload Images -->
          <div class="my-2">
            <label class="form-label">Upload Images</label>
            <input type="file" (change)="onFileChange($event)" multiple class="form-control" />
          </div>
          <div class="modal-footer py-2">
            <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary btn-sm">Add</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="updateProductModal" tabindex="-1">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title">Edit Product</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="max-height: 380px; overflow-y: auto; padding: 10px 18px">
        <form [formGroup]="addProductForm" (ngSubmit)="submitEditProduct(selectedProductId)">
          <div class="my-2">
            <label class="form-label">Product Name</label>
            <input formControlName="productName" type="text" class="form-control" />
          </div>
          <div class="my-2">
            <label class="form-label">Description</label>
            <input formControlName="productDesc" type="text" class="form-control" />
          </div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Price</label>
              <input formControlName="price" type="number" class="form-control" />
            </div>
            <div class="col-6">
              <label class="form-label">Discount</label>
              <input formControlName="discountPrice" type="number" class="form-control" />
            </div>
          </div>
          <div class="row g-2 my-2">
            <div class="col-6">
              <label class="form-label">Category</label>
              <select
                class="form-select"
                formControlName="category"
                (change)="onCategoryChange($event)"
              >
                <option value="">Select Category</option>
                <ng-container *ngFor="let cat of uniqueCategories">
                  <option [value]="cat">{{ cat }}</option>
                </ng-container>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Stock</label>
              <input formControlName="stock" type="number" class="form-control" />
            </div>
          </div>
          <div class="my-2">
            <label class="form-label">Sub Category</label>
            <select class="form-select" formControlName="subCategory">
              <option value="">Select Sub Category</option>
              <ng-container *ngFor="let sub of filteredSubCategories">
                <option [value]="sub.name">{{ sub.name }}</option>
              </ng-container>
            </select>
          </div>
          <div class="my-2">
            <label class="form-label">Upload Images</label>
            <input type="file" (change)="onFileChange($event)" multiple class="form-control" />
          </div>
          <div class="modal-footer py-2">
            <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary btn-sm">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<br />

<!-- Main Products Grid -->
<section class="container my-5 mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">All Products</h2>
    <div class="input-group w-50 shadow-sm">
      <input
        [(ngModel)]="searchValue"
        type="search"
        placeholder="Search by name..."
        class="form-control"
      />
      <button class="btn btn-dark">Search</button>
    </div>
    <button class="btn-main" data-bs-toggle="modal" data-bs-target="#addProductModal">
      Add Product
    </button>
  </div>

  <div class="row g-4">
    <div
      class="col-6 col-md-4 col-lg-3"
      *ngFor="let product of productsList | search : searchValue"
    >
      <div
        class="product-card rounded-4 shadow-sm p-3 h-100 d-flex flex-column position-relative"
        [ngClass]="{ 'deleted-product': product.isDeleted }"
      >
        <div *ngIf="product.isDeleted" class="deleted-badge">Deleted</div>
        <img
          [src]="baseURi + '/uploads/images/' + product.images[0]"
          class="w-100 rounded-3 object-fit-cover"
          height="220"
          [alt]="product.productName"
        />
        <h4 class="small mt-2 text-main fw-bold">{{ product.category.name }}</h4>
        <h3 class="h6 mb-2">{{ product.productName }}</h3>
        <div class="mt-3">
          <span class="text-danger fw-bold"
            >{{ ((product.discountPrice / product.price) * 100).toFixed(0) }}% OFF</span
          >
          <div class="mt-2">
            <span class="h5 text-success fw-bold"
              >{{ product.price - product.discountPrice }} EGP</span
            >
            <span class="ms-2 text-muted text-decoration-line-through"
              >{{ product.price }} EGP</span
            >
          </div>

          <div class="mt-2">
            <span
              style="font-size: smaller"
              class="text-danger fw-bold"
              *ngIf="product.stock <= 5 && product.stock !== 0"
            >
              {{ product.stock }} items remainig in the stock
            </span>
            <span
              style="font-size: smaller"
              class="text-danger fw-bold"
              *ngIf="product.stock === 0"
            >
              Out of stock
            </span>
          </div>
        </div>
        <div class="mt-auto d-flex gap-2">
          <button
            class="btn btn-warning w-50"
            [disabled]="product.isDeleted"
            (click)="editProduct(product)"
            data-bs-toggle="modal"
            data-bs-target="#updateProductModal"
          >
            Edit
          </button>
          <button
            class="btn btn-danger w-50"
            [disabled]="product.isDeleted"
            (click)="softDeleteProduct(product._id)"
          >
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
